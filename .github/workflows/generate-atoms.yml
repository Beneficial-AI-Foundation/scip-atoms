# Reusable workflow for generating call graph atoms from Rust/Verus projects
# 
# Uses scip-atoms to generate compact function call graph data from any Rust/Verus repository.
#
# Usage - analyze a specific external repo:
#   jobs:
#     generate-dalek:
#       uses: Beneficial-AI-Foundation/scip-atoms/.github/workflows/generate-atoms.yml@main
#       with:
#         target_repo: Beneficial-AI-Foundation/dalek-lite
#         artifact_name: dalek-atoms
#
# Usage - analyze multiple repos (matrix):
#   jobs:
#     generate:
#       strategy:
#         matrix:
#           include:
#             - repo: Beneficial-AI-Foundation/dalek-lite
#               name: dalek
#             - repo: some-org/other-verus-project
#               name: other
#       uses: Beneficial-AI-Foundation/scip-atoms/.github/workflows/generate-atoms.yml@main
#       with:
#         target_repo: ${{ matrix.repo }}
#         artifact_name: ${{ matrix.name }}-atoms
#
# For non-Verus Rust projects, use rust-analyzer:
#   jobs:
#     generate:
#       uses: Beneficial-AI-Foundation/scip-atoms/.github/workflows/generate-atoms.yml@main
#       with:
#         target_repo: rust-lang/some-rust-project
#         use_rust_analyzer: true
#
name: Generate Atoms

on:
  workflow_call:
    inputs:
      target_repo:
        description: 'Repository to analyze (org/repo format, e.g., "Beneficial-AI-Foundation/dalek-lite")'
        required: true
        type: string
      target_ref:
        description: 'Branch, tag, or SHA to checkout (default: default branch)'
        required: false
        default: ''
        type: string
      project_path:
        description: 'Path to the Rust/Verus project within the repo (relative to repo root)'
        required: false
        default: '.'
        type: string
      use_rust_analyzer:
        description: 'Use rust-analyzer instead of verus-analyzer (for non-Verus projects)'
        required: false
        default: false
        type: boolean
      artifact_name:
        description: 'Name for the uploaded artifact'
        required: false
        default: 'atoms-json'
        type: string

jobs:
  build:
    name: Generate Atoms
    runs-on: ubuntu-latest
    
    outputs:
      artifact_name: ${{ inputs.artifact_name }}
    
    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.target_repo }}
          ref: ${{ inputs.target_ref || '' }}
          path: project

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@1.91.0

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin
          key: ${{ runner.os }}-cargo-scip-atoms-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-scip-atoms-

      - name: Install verus-analyzer
        if: ${{ !inputs.use_rust_analyzer }}
        run: |
          wget -q "https://github.com/verus-lang/verus-analyzer/releases/latest/download/verus-analyzer-x86_64-unknown-linux-gnu.gz" -O verus-analyzer.gz
          gunzip verus-analyzer.gz
          chmod +x verus-analyzer
          sudo mv verus-analyzer /usr/local/bin/
          verus-analyzer --version

      - name: Install rust-analyzer
        if: ${{ inputs.use_rust_analyzer }}
        run: |
          wget -q "https://github.com/rust-lang/rust-analyzer/releases/latest/download/rust-analyzer-x86_64-unknown-linux-gnu.gz" -O rust-analyzer.gz
          gunzip rust-analyzer.gz
          chmod +x rust-analyzer
          sudo mv rust-analyzer /usr/local/bin/
          /usr/local/bin/rust-analyzer --version

      - name: Install scip CLI
        run: |
          wget -q "https://github.com/sourcegraph/scip/releases/latest/download/scip-linux-amd64.tar.gz" -O scip-linux.tar.gz
          tar -xzf scip-linux.tar.gz
          chmod +x scip
          sudo mv scip /usr/local/bin/
          scip --version

      - name: Install scip-atoms
        run: |
          cargo install --force --git https://github.com/Beneficial-AI-Foundation/scip-atoms

      - name: Generate atoms
        working-directory: project/${{ inputs.project_path }}
        run: |
          mkdir -p ${{ github.workspace }}/output
          scip-atoms atoms . -o ${{ github.workspace }}/output/atoms.json
          echo "Generated atoms.json:"
          ls -la ${{ github.workspace }}/output/atoms.json
          echo "Preview (first 50 lines):"
          head -50 ${{ github.workspace }}/output/atoms.json

      - name: Upload atoms.json artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: ${{ github.workspace }}/output/atoms.json
          retention-days: 30

